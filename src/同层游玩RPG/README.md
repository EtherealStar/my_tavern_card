# 同层游玩RPG

一个基于酒馆助手的同层游玩RPG游戏，采用现代化模块架构设计，支持分步角色创建、Mvu变量管理和AI内容生成。

## 重构后的项目结构

```
src/同层游玩RPG/
├── core/                      # 核心架构组件
│   ├── GameCore.ts           # 🎮 中央协调器 - 管理组件生命周期
│   ├── ServiceLocator.ts     # 🔧 服务定位器 - 依赖注入和服务管理
│   ├── EventBus.ts          # 📡 事件总线 - 组件间通信
│   └── StateManager.ts      # 📊 状态管理器 - 游戏状态管理
├── models/                   # 数据模型和验证
│   └── schemas.ts           # 📋 Zod模式定义和类型
├── services/                # 业务服务层
│   ├── MvuVariableService.ts # 🔄 Mvu变量服务 - 基于Mvu框架
│   ├── SameLayerService.ts  # 📝 同层服务 - 第0层消息管理
│   ├── WorldbookService.ts  # 📚 世界书服务 - 存档管理
│   └── AchievementService.ts # 🏆 成就系统
├── controllers/             # MVC控制器层
│   ├── BaseController.ts    # 🏗️ 基础控制器
│   ├── StartController.ts   # 🚀 开始界面控制器
│   ├── CreationController.ts # ⚙️ 角色创建控制器
│   └── PlayController.ts    # 🎲 游戏界面控制器
├── views/                   # 界面模板
│   ├── start.html          # 开始界面
│   ├── creation-steps.html # 分步创建界面
│   └── playing.html        # 游戏界面（含流式生成按钮）
├── data/                    # 游戏数据
│   ├── attributes.ts       # 属性定义
│   ├── backgrounds.ts      # 背景数据
│   └── talents.ts         # 天赋数据
└── index.ts               # 🎯 主入口文件
```

## 核心功能

### 1. 分步角色创建流程

- **难度选择**: 简单(60点)、普通(50点)、困难(40点)
- **世界选择**: 西幻、都市、武侠、仙侠
- **角色选择**: 预设角色(有主线)、自定义角色(无主线)
- **属性分配**: 力量、敏捷、智力、体质、魅力、意志、幸运
- **天赋选择**: 多种天赋可选择组合

### 2. 导航系统

- 上一步/下一步按钮智能控制
- 每步完成验证，未完成时禁用下一步
- 最后一步显示"开始游戏"按钮
- "返回主菜单"随时可用

### 3. 状态管理

- 使用 `GameState` 统一管理游戏状态
- 支持步骤间状态保持和回退
- 实时UI更新和验证

### 4. AI生成集成

- **流式生成**: 支持实时流式AI内容生成
- **普通生成**: 传统的一次性AI内容生成
- **第0层覆盖**: 直接覆盖第0层消息，不继续生成后续层
- **酒馆助手集成**: 使用酒馆提供的generate函数

### 5. Mvu变量管理

- **统一变量接口**: 基于Mvu变量框架的统一变量操作
- **事件监听**: 监听Mvu变量更新事件
- **类型安全**: TypeScript类型安全的变量访问

## 重构后的技术架构

### 设计模式

- **MVC架构**: 模型、视图、控制器清晰分离
- **服务定位器模式**: 依赖注入和服务生命周期管理
- **事件总线模式**: 支持命名空间和通配符的松耦合通信
- **状态管理模式**: 响应式状态更新和历史回退
- **单例模式**: GameCore中央协调器
- **观察者模式**: 事件驱动的成就系统

### 核心组件

- **GameCore**: 🎮 中央协调器，管理整个游戏的初始化和生命周期
- **ServiceLocator**: 🔧 增强的服务定位器，支持工厂模式和依赖注入
- **EventBus**: 📡 强化的事件总线，支持异步事件和调试功能
- **StateManager**: 📊 状态管理器，集成Zod验证和自动纠错

### 技术特性

- **Zod数据验证**: 替换if-else判断，自动数据纠错和类型安全
- **Mvu变量框架**: 统一的酒馆变量管理，监听变量更新事件
- **jQuery操作**: 现代化的DOM操作，避免原生JavaScript
- **TypeScript最佳实践**: 严格类型检查和接口定义
- **酒馆助手集成**: 直接使用酒馆AI生成功能，支持流式和非流式

## 使用说明

### 基础操作

1. **开始游戏**: 点击"开始游戏"进入角色创建
2. **角色创建**: 按步骤完成难度、世界、属性、天赋选择
3. **导航**: 使用"上一步"/"下一步"在步骤间切换
4. **开始游玩**: 完成所有步骤后点击"开始游戏"
5. **存档/读档**: 在游戏界面使用保存和加载功能

### AI生成功能

- **普通生成**: 点击"普通生成"按钮，一次性生成完整内容
- **流式生成**: 点击"流式生成"按钮，实时流式生成内容
- **内容覆盖**: 生成的内容直接覆盖第0层消息，不会继续生成1层和2层

### 数据管理

- **自动验证**: 所有数据输入都通过Zod进行验证
- **自动纠错**: 无效数据会自动纠正并提示用户
- **Mvu集成**: 游戏状态通过Mvu变量框架管理

## 样式设计

- 采用现代圆角卡片设计
- 响应式布局，支持移动端和桌面端
- 4:3宽高比，支持全屏模式
- 渐变色彩搭配，营造游戏氛围

## 扩展性

项目采用模块化设计，易于扩展：

- 添加新的世界类型
- 扩展角色属性系统
- 增加更多天赋选项
- 集成更多AI功能
- 添加成就系统

## 重构完成状态

### ✅ 已完成

- **核心架构**: GameCore中央协调器、ServiceLocator、EventBus、StateManager
- **数据验证**: Zod模式定义和自动纠错功能
- **MVC架构**: 控制器分离，BaseController基类
- **Mvu集成**: MvuVariableService统一变量管理
- **同层服务**: 第0层消息获取和覆盖，支持流式和非流式生成
- **世界书服务**: 增强的存档管理功能
- **成就系统**: 事件驱动的成就解锁机制
- **jQuery操作**: 全面使用jQuery替代原生DOM操作

### 🎯 架构优势

- **解耦**: 各模块职责单一，依赖关系清晰
- **可维护**: 模块化设计，易于扩展和修改
- **类型安全**: 完整的TypeScript类型定义
- **错误处理**: 统一的错误处理和用户反馈
- **调试支持**: 完善的日志和调试功能

### 🔧 开发工具

- **服务调试**: `ServiceLocator.printDebugInfo()`
- **事件调试**: `EventBus.printDebugInfo()`
- **状态快照**: `StateManager.getStateSnapshot()`
- **Mvu监控**: 集成Mvu事件监听

```html
<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>魔法少女状态面板</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Orbitron:wght@400;500;700;900&display=swap');

      :root {
        --primary-bg: #fdf3f4;
        --secondary-bg: #ffffff;
        --widget-bg: rgba(255, 255, 255, 0.75);
        --text-title: #d97e81;
        --text-main: #f09699;
        --text-secondary: #c4a8a9;
        --border-color: rgba(240, 150, 153, 0.2);
        --shadow-color: rgba(217, 126, 129, 0.1);
        --progress-exp: #a8e6cf;
        --progress-fallen: #ff80ab;
        --progress-affection: #d7b9ff;
        --font-main: 'Noto Sans SC', sans-serif;
        --font-numeric: 'Orbitron', sans-serif;
        --error-color: #ff6b6b;
        /* Avatar sizes (Plan A) */
        --selector-size: 72px;
        --card-avatar-size: 96px;
      }

      body {
        font-family: var(--font-main);
        background-color: transparent;
        margin: 0;
        padding: 0;
        color: var(--text-main);
        -webkit-font-smoothing: antialiased;
        text-rendering: optimizeLegibility;
      }

      .status-card {
        background: var(--primary-bg);
        border: 1px solid var(--border-color);
        border-radius: 18px;
        padding: 18px;
        box-shadow: 0 8px 35px var(--shadow-color);
        display: grid;
        grid-template-columns: 130px 1fr;
        grid-template-rows: auto auto auto auto;
        gap: 12px;
        grid-template-areas:
          'player-info world-time'
          'player-info main-stats'
          'skills skills'
          'relationships relationships';
        position: relative;
        overflow: hidden;
        width: 100%;
        max-width: 880px;
        margin: 20px auto 0 auto;
        box-sizing: border-box;
      }

      .animation-background {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
      }
      .square {
        position: absolute;
        bottom: -150px;
        width: 10px;
        height: 10px;
        background-color: rgba(255, 182, 193, 0.2);
        border: 1px solid rgba(255, 182, 193, 0.3);
        animation: rise-inside 15s infinite ease-in;
      }
      .square:nth-child(1) {
        left: 10%;
        animation-duration: 20s;
        animation-delay: 0s;
      }
      .square:nth-child(2) {
        left: 20%;
        animation-duration: 15s;
        animation-delay: 2s;
        width: 20px;
        height: 20px;
      }
      .square:nth-child(3) {
        left: 30%;
        animation-duration: 25s;
        animation-delay: 4s;
      }
      .square:nth-child(4) {
        left: 40%;
        animation-duration: 18s;
        animation-delay: 1s;
        width: 15px;
        height: 15px;
      }
      .square:nth-child(5) {
        left: 50%;
        animation-duration: 22s;
        animation-delay: 3s;
      }
      .square:nth-child(6) {
        left: 60%;
        animation-duration: 13s;
        animation-delay: 5s;
        width: 25px;
        height: 25px;
      }
      .square:nth-child(7) {
        left: 70%;
        animation-duration: 28s;
        animation-delay: 2s;
      }
      .square:nth-child(8) {
        left: 80%;
        animation-duration: 16s;
        animation-delay: 6s;
        width: 12px;
        height: 12px;
      }
      .square:nth-child(9) {
        left: 90%;
        animation-duration: 19s;
        animation-delay: 0s;
      }
      .square:nth-child(10) {
        left: 5%;
        animation-duration: 23s;
        animation-delay: 7s;
      }
      @keyframes rise-inside {
        0% {
          transform: translateY(0) rotate(0deg);
          opacity: 0.7;
        }
        90% {
          opacity: 0.1;
        }
        100% {
          transform: translateY(-1000px) rotate(360deg);
          opacity: 0;
        }
      }

      .widget {
        background: var(--widget-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 4px 15px var(--shadow-color);
        z-index: 1;
      }

      .main-stats-container,
      .char-main-stats-container {
        grid-area: main-stats;
        display: grid;
        grid-template-columns: 3fr 1fr;
        gap: 12px;
      }
      .char-main-stats-container {
        grid-column: 1 / -1;
      }

      .progress-stats-box {
        background: var(--widget-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 10px 12px;
        box-shadow: 0 4px 15px var(--shadow-color);
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 8px;
      }
      .char-progress-stats-box {
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 8px 10px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 6px;
      }

      .progress-widget {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .progress-title {
        font-size: 0.85em;
        color: var(--text-secondary);
        width: 50px;
        text-align: right;
        flex-shrink: 0;
      }
      .char-progress-stats-box .progress-title {
        font-size: 0.75em;
        width: 45px;
      }

      .progress-bar-wrapper {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }

      .progress-bar-container {
        background-color: rgba(0, 0, 0, 0.05);
        border-radius: 10px;
        height: 10px;
        width: 100%;
        overflow: hidden;
        border: 1px solid var(--border-color);
      }
      .char-progress-stats-box .progress-bar-container {
        height: 8px;
      }
      .progress-bar-value {
        height: 100%;
        border-radius: 8px;
        transition: width 0.5s ease-in-out;
      }
      .progress-value-text {
        font-family: var(--font-numeric);
        font-size: 0.8em;
        text-align: right;
        color: var(--text-secondary);
        margin-top: 2px;
      }
      .char-progress-stats-box .progress-value-text {
        font-size: 0.7em;
      }

      .grade-widget {
        background: var(--widget-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 4px 15px var(--shadow-color);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 10px;
      }

      .char-grade-widget {
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 8px;
      }

      .grade-title {
        font-size: 0.85em;
        color: var(--text-secondary);
        margin-bottom: 4px;
      }
      .char-grade-widget .grade-title {
        font-size: 0.75em;
        margin-bottom: 2px;
      }

      .grade-main-value {
        font-family: var(--font-numeric);
        font-size: 2.2em;
        font-weight: 700;
        color: var(--text-title);
        line-height: 1;
      }
      .char-grade-widget .grade-main-value {
        font-size: 1.8em;
      }

      .player-info-widget {
        grid-area: player-info;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        padding: 15px;
      }
      .avatar-container {
        width: 90px;
        height: 90px;
        border-radius: 50%;
        border: 3px solid var(--text-title);
        background: var(--secondary-bg);
        padding: 3px;
      }
      .user_avatar {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        overflow: hidden;
        position: relative;
        background-size: cover;
        background-position: center;
      }
      .player-name {
        font-weight: 700;
        font-size: 1.1em;
        color: var(--text-title);
        text-align: center;
      }
      .location-tag {
        background: var(--text-title);
        border-radius: 8px;
        padding: 4px 8px;
        font-size: 0.8em;
        color: var(--primary-bg);
        text-align: center;
        width: 100%;
      }

      .world-time-widget {
        grid-area: world-time;
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 10px 15px;
      }
      .time-block {
        text-align: center;
        flex: 2;
      }
      .event-block,
      .countdown-block {
        text-align: center;
        flex: 1;
      }
      .widget-label {
        font-size: 0.8em;
        color: var(--text-secondary);
        margin-bottom: 5px;
      }
      #datetime-value {
        font-family: var(--font-numeric);
        font-size: 1.1em;
        font-weight: 500;
      }
      #random-event-value {
        font-size: 1.1em;
        font-weight: 700;
      }
      #countdown-value {
        font-family: var(--font-numeric);
        font-size: 2em;
        font-weight: 900;
        color: var(--text-title);
      }

      .skills-widget {
        grid-area: skills;
      }
      .skills-title,
      .char-thoughts-title {
        font-weight: 700;
        color: var(--text-title);
        margin-bottom: 8px;
        font-size: 1em;
        text-align: left;
      }
      .skill-list,
      .char-thoughts-content {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 110px;
        overflow-y: auto;
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
      }
      .skill-list-item {
        padding: 8px 12px;
        border-bottom: 1px solid var(--border-color);
      }
      .skill-list-item:last-child {
        border-bottom: none;
      }
      .skill-name {
        font-weight: 700;
        margin-bottom: 2px;
        color: var(--text-title);
        font-size: 0.95em;
      }
      .skill-level {
        font-size: 0.75em;
        color: var(--text-secondary);
        font-weight: 700;
        margin-bottom: 3px;
      }
      .skill-desc {
        font-size: 0.85em;
        color: var(--text-main);
        line-height: 1.4;
      }

      .char-thoughts-widget {
        margin-bottom: 10px;
      }
      .char-thoughts-content {
        max-height: 60px;
        padding: 10px;
        font-style: italic;
        color: #8a6d8f;
      }

      .relationships-widget {
        grid-area: relationships;
        padding: 12px;
        background: transparent;
        z-index: 1;
      }
      .relationships-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .relationships-title {
        font-weight: 700;
        color: var(--text-title);
        font-size: 1em;
      }
      .char-avatar-selectors {
        display: flex;
        gap: 15px;
      }
      .char-avatar-selector {
        width: var(--selector-size);
        height: var(--selector-size);
        border-radius: 50%;
        background: var(--secondary-bg);
        border: 2px solid var(--border-color);
        cursor: pointer;
        transition: all 0.3s ease;
        overflow: hidden;
        position: relative;
        box-sizing: border-box;
      }
      .char-avatar-selector:hover,
      .char-avatar-selector.active {
        border-color: var(--text-title);
        box-shadow: 0 0 10px var(--shadow-color);
      }

      .character-card {
        display: none;
        background: var(--widget-bg);
        border-radius: 12px;
        padding: 12px;
        gap: 12px;
        border: 1px solid var(--border-color);
        margin-top: 15px;
      }
      .character-card.expanded {
        display: flex;
      }

      .char-left {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        width: calc(var(--card-avatar-size) + 10px);
        flex-shrink: 0;
      }
      .char-avatar {
        width: var(--card-avatar-size);
        height: var(--card-avatar-size);
        border-radius: 50%;
        background: var(--secondary-bg);
        border: 2px solid var(--border-color);
        overflow: hidden;
        position: relative;
        box-sizing: border-box;
      }

      .avatar-img {
        position: absolute;
        inset: -1px;
        width: calc(100% + 2px) !important;
        height: calc(100% + 2px) !important;
        max-width: none !important;
        max-height: none !important;
        object-fit: cover;
        object-position: center;
        display: block;
        pointer-events: none;
        transform: translateZ(0);
      }
      .char-name {
        font-weight: 700;
        text-align: center;
        color: var(--text-title);
        font-size: 0.9em;
      }

      .char-right {
        flex-grow: 1;
        display: grid;
        grid-template-rows: auto auto 1fr;
        gap: 8px;
        align-content: flex-start;
      }
      .char-thoughts {
        grid-row: 2;
      }
      .char-skills {
        grid-row: 3;
      }
      .char-skills .skills-title,
      .char-thoughts .char-thoughts-title {
        font-size: 0.8em;
        text-align: left;
        color: var(--text-title);
        margin-bottom: 4px;
        font-weight: normal;
      }

      .error-fallback {
        color: var(--error-color);
        background: rgba(255, 107, 107, 0.1);
        border: 1px solid var(--error-color);
        padding: 20px;
        border-radius: 12px;
        margin: 10px;
        text-align: center;
        font-size: 1.1em;
      }
      /* ---------- Responsive: Tablet ---------- */
      @media (max-width: 1024px) {
        .status-card {
          max-width: 720px;
          padding: 16px;
          gap: 10px;
        }
        .widget {
          padding: 10px;
        }
        .skills-title,
        .char-thoughts-title,
        .relationships-title,
        .player-name {
          font-size: 0.95em;
        }
      }

      /* ---------- Responsive: Phone ---------- */
      @media (max-width: 768px) {
        :root {
          --selector-size: 56px;
          --card-avatar-size: 84px;
        }

        .status-card {
          grid-template-columns: 1fr;
          grid-template-rows: auto;
          grid-template-areas:
            'player-info'
            'world-time'
            'main-stats'
            'skills'
            'relationships';
          padding: 14px;
          gap: 10px;
          max-width: 100%;
          margin: 12px auto 0 auto;
        }

        /* iOS 安全区适配 */
        @supports (padding: max(0px)) {
          .status-card {
            padding-left: max(14px, env(safe-area-inset-left));
            padding-right: max(14px, env(safe-area-inset-right));
            padding-top: max(14px, env(safe-area-inset-top));
            padding-bottom: max(14px, env(safe-area-inset-bottom));
          }
        }

        /* 用户头像缩小 */
        .avatar-container {
          width: 68px;
          height: 68px;
          border-width: 2px;
          padding: 2px;
        }

        /* 世界时间纵向排布 */
        .world-time-widget {
          display: flex;
          flex-direction: column;
          gap: 6px;
          padding: 10px;
        }
        #datetime-value {
          font-size: 1em;
        }
        #random-event-value {
          font-size: 1em;
        }
        #countdown-value {
          font-size: 1.6em;
        }

        /* 主属性区域改单列 */
        .main-stats-container,
        .char-main-stats-container {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        /* 成长条更紧凑 */
        .progress-title {
          width: 42px;
          font-size: 0.78em;
        }
        .progress-bar-container {
          height: 8px;
        }
        .char-progress-stats-box .progress-bar-container {
          height: 6px;
        }
        .progress-value-text {
          font-size: 0.75em;
        }
        .grade-widget .grade-main-value {
          font-size: 1.6em;
        }
        .char-grade-widget .grade-main-value {
          font-size: 1.4em;
        }

        /* 技能/想法列表高度使用视窗比例 */
        .skill-list {
          max-height: min(40vh, 260px);
        }
        .char-thoughts-content {
          max-height: 18vh;
        }

        /* 角色选择器允许横向滚动 */
        .char-avatar-selectors {
          display: flex;
          gap: 10px;
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          padding-bottom: 6px;
        }

        /* 角色卡纵向堆叠 */
        .character-card {
          flex-direction: column;
          align-items: stretch;
        }
        .char-left {
          width: 100%;
          align-items: center;
        }

        /* 小屏性能优化：隐藏背景动画 */
        .animation-background {
          display: none;
        }
      }

      /* ---------- Responsive: Small Phone ---------- */
      @media (max-width: 480px) {
        :root {
          --selector-size: 48px;
          --card-avatar-size: 72px;
        }

        .status-card {
          padding: 12px;
          gap: 8px;
        }
        .widget {
          padding: 10px;
        }
        .avatar-container {
          width: 60px;
          height: 60px;
        }
        .player-name {
          font-size: 1em;
        }

        /* 文本更紧凑 */
        .skills-title,
        .char-thoughts-title,
        .relationships-title {
          font-size: 0.95em;
        }
        .grade-widget .grade-main-value {
          font-size: clamp(1.2rem, 6vw, 1.5rem);
        }
        .char-grade-widget .grade-main-value {
          font-size: clamp(1.1rem, 5.5vw, 1.3rem);
        }

        /* 进度条与标题自适应 */
        .progress-widget {
          align-items: center;
          gap: 8px;
        }
        .progress-title {
          width: auto;
          min-width: 38px;
          text-align: left;
          margin-right: 6px;
        }

        /* 列表进一步收紧 */
        .skill-list {
          max-height: min(36vh, 220px);
        }
        .char-thoughts-content {
          max-height: 14vh;
        }
        .char-avatar-selectors {
          gap: 8px;
        }
        .char-name {
          font-size: 0.85em;
        }
      }
    </style>
  </head>
  <body>
    <div class="status-card" id="status-card">
      <div class="animation-background">
        <div class="square"></div>
        <div class="square"></div>
        <div class="square"></div>
        <div class="square"></div>
        <div class="square"></div>
        <div class="square"></div>
        <div class="square"></div>
        <div class="square"></div>
        <div class="square"></div>
        <div class="square"></div>
      </div>
      <div class="widget player-info-widget">
        <div class="avatar-container"><div id="user-avatar" class="user_avatar"></div></div>
        <div class="player-name" id="player-name-display">{{user}}</div>
        <div class="location-tag" id="location-info">--</div>
      </div>
      <div class="widget world-time-widget">
        <div class="time-block">
          <div class="widget-label">日期 & 时间</div>
          <div id="datetime-value">--/--/-- // -- // --:--</div>
        </div>
        <div class="event-block">
          <div class="widget-label">当前事件</div>
          <div id="random-event-value">--</div>
        </div>
        <div class="countdown-block">
          <div class="widget-label">入侵倒计时</div>
          <div id="countdown-value">--</div>
        </div>
      </div>
      <div class="main-stats-container">
        <div class="progress-stats-box">
          <div class="progress-widget">
            <div class="progress-title">经验值</div>
            <div class="progress-bar-wrapper">
              <div class="progress-bar-container">
                <div id="user-exp-bar" class="progress-bar-value" style="background-color: var(--progress-exp)"></div>
              </div>
              <div class="progress-value-text" id="user-exp-value">0 / 100</div>
            </div>
          </div>
          <div class="progress-widget">
            <div class="progress-title">淫堕值</div>
            <div class="progress-bar-wrapper">
              <div class="progress-bar-container">
                <div
                  id="user-fallen-bar"
                  class="progress-bar-value"
                  style="background-color: var(--progress-fallen)"
                ></div>
              </div>
              <div class="progress-value-text" id="user-fallen-value">0 / 200</div>
            </div>
          </div>
        </div>
        <div class="grade-widget">
          <div class="grade-title">实力等级</div>
          <div class="grade-main-value" id="user-grade-value">--</div>
        </div>
      </div>
      <div class="widget skills-widget">
        <div class="skills-title" id="user-skills-title">{{user}} 技能</div>
        <ul class="skill-list" id="user-skills-list"></ul>
      </div>
      <div class="widget relationships-widget">
        <div class="relationships-header">
          <span class="relationships-title">魔法少女们</span>
          <div class="char-avatar-selectors">
            <div id="zion-avatar-selector" class="char-avatar-selector" onclick="toggleCharacterCard('zion')"></div>
            <div id="rin-avatar-selector" class="char-avatar-selector" onclick="toggleCharacterCard('rin')"></div>
            <div id="kaede-avatar-selector" class="char-avatar-selector" onclick="toggleCharacterCard('kaede')"></div>
          </div>
        </div>
        <div class="character-card" id="zion-card">
          <div class="char-left">
            <div id="zion-card-avatar" class="char-avatar"></div>
            <span class="char-name">伊吹 紫音</span>
          </div>
          <div class="char-right">
            <div class="char-main-stats-container">
              <div class="char-progress-stats-box">
                <div class="progress-widget">
                  <div class="progress-title">好感度</div>
                  <div class="progress-bar-wrapper">
                    <div class="progress-bar-container">
                      <div
                        id="zion-affinity-bar"
                        class="progress-bar-value"
                        style="background-color: var(--progress-affection)"
                      ></div>
                    </div>
                    <div class="progress-value-text" id="zion-affinity-value">0 / 200</div>
                  </div>
                </div>
                <div class="progress-widget">
                  <div class="progress-title">经验值</div>
                  <div class="progress-bar-wrapper">
                    <div class="progress-bar-container">
                      <div
                        id="zion-exp-bar"
                        class="progress-bar-value"
                        style="background-color: var(--progress-exp)"
                      ></div>
                    </div>
                    <div class="progress-value-text" id="zion-exp-value">0 / 100</div>
                  </div>
                </div>
                <div class="progress-widget">
                  <div class="progress-title">淫堕值</div>
                  <div class="progress-bar-wrapper">
                    <div class="progress-bar-container">
                      <div
                        id="zion-fallen-bar"
                        class="progress-bar-value"
                        style="background-color: var(--progress-fallen)"
                      ></div>
                    </div>
                    <div class="progress-value-text" id="zion-fallen-value">0 / 200</div>
                  </div>
                </div>
              </div>
              <div class="char-grade-widget">
                <div class="grade-title">实力等级</div>
                <div class="grade-main-value" id="zion-grade-value">--</div>
              </div>
            </div>
            <div class="char-thoughts char-thoughts-widget">
              <div class="char-thoughts-title">内心想法</div>
              <div class="char-thoughts-content" id="zion-thoughts-content"></div>
            </div>
            <div class="char-skills">
              <div class="skills-title">技能</div>
              <ul class="skill-list" id="zion-skills-list"></ul>
            </div>
          </div>
        </div>
        <div class="character-card" id="rin-card">
          <div class="char-left">
            <div id="rin-card-avatar" class="char-avatar"></div>
            <span class="char-name">梦咲 凛</span>
          </div>
          <div class="char-right">
            <div class="char-main-stats-container">
              <div class="char-progress-stats-box">
                <div class="progress-widget">
                  <div class="progress-title">好感度</div>
                  <div class="progress-bar-wrapper">
                    <div class="progress-bar-container">
                      <div
                        id="rin-affinity-bar"
                        class="progress-bar-value"
                        style="background-color: var(--progress-affection)"
                      ></div>
                    </div>
                    <div class="progress-value-text" id="rin-affinity-value">0 / 200</div>
                  </div>
                </div>
                <div class="progress-widget">
                  <div class="progress-title">经验值</div>
                  <div class="progress-bar-wrapper">
                    <div class="progress-bar-container">
                      <div
                        id="rin-exp-bar"
                        class="progress-bar-value"
                        style="background-color: var(--progress-exp)"
                      ></div>
                    </div>
                    <div class="progress-value-text" id="rin-exp-value">0 / 100</div>
                  </div>
                </div>
                <div class="progress-widget">
                  <div class="progress-title">淫堕值</div>
                  <div class="progress-bar-wrapper">
                    <div class="progress-bar-container">
                      <div
                        id="rin-fallen-bar"
                        class="progress-bar-value"
                        style="background-color: var(--progress-fallen)"
                      ></div>
                    </div>
                    <div class="progress-value-text" id="rin-fallen-value">0 / 200</div>
                  </div>
                </div>
              </div>
              <div class="char-grade-widget">
                <div class="grade-title">实力等级</div>
                <div class="grade-main-value" id="rin-grade-value">--</div>
              </div>
            </div>
            <div class="char-thoughts char-thoughts-widget">
              <div class="char-thoughts-title">内心想法</div>
              <div class="char-thoughts-content" id="rin-thoughts-content"></div>
            </div>
            <div class="char-skills">
              <div class="skills-title">技能</div>
              <ul class="skill-list" id="rin-skills-list"></ul>
            </div>
          </div>
        </div>
        <div class="character-card" id="kaede-card">
          <div class="char-left">
            <div id="kaede-card-avatar" class="char-avatar"></div>
            <span class="char-name">赤城 枫</span>
          </div>
          <div class="char-right">
            <div class="char-main-stats-container">
              <div class="char-progress-stats-box">
                <div class="progress-widget">
                  <div class="progress-title">好感度</div>
                  <div class="progress-bar-wrapper">
                    <div class="progress-bar-container">
                      <div
                        id="kaede-affinity-bar"
                        class="progress-bar-value"
                        style="background-color: var(--progress-affection)"
                      ></div>
                    </div>
                    <div class="progress-value-text" id="kaede-affinity-value">0 / 200</div>
                  </div>
                </div>
                <div class="progress-widget">
                  <div class="progress-title">经验值</div>
                  <div class="progress-bar-wrapper">
                    <div class="progress-bar-container">
                      <div
                        id="kaede-exp-bar"
                        class="progress-bar-value"
                        style="background-color: var(--progress-exp)"
                      ></div>
                    </div>
                    <div class="progress-value-text" id="kaede-exp-value">0 / 100</div>
                  </div>
                </div>
                <div class="progress-widget">
                  <div class="progress-title">淫堕值</div>
                  <div class="progress-bar-wrapper">
                    <div class="progress-bar-container">
                      <div
                        id="kaede-fallen-bar"
                        class="progress-bar-value"
                        style="background-color: var(--progress-fallen)"
                      ></div>
                    </div>
                    <div class="progress-value-text" id="kaede-fallen-value">0 / 200</div>
                  </div>
                </div>
              </div>
              <div class="char-grade-widget">
                <div class="grade-title">实力等级</div>
                <div class="grade-main-value" id="kaede-grade-value">--</div>
              </div>
            </div>
            <div class="char-thoughts char-thoughts-widget">
              <div class="char-thoughts-title">内心想法</div>
              <div class="char-thoughts-content" id="kaede-thoughts-content"></div>
            </div>
            <div class="char-skills">
              <div class="skills-title">技能</div>
              <ul class="skill-list" id="kaede-skills-list"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      function SafeGetValue(obj, path, defaultValue = null) {
        try {
          if (!path || typeof path !== 'string' || !obj) return defaultValue;
          const keys = path.match(/([^[.\]]+)|(\[\d+\])/g);
          if (!keys) return defaultValue;

          let current = obj;
          for (const key of keys) {
            if (current === null || current === undefined) return defaultValue;
            const arrayMatch = key.match(/^\[(\d+)\]$/);
            if (arrayMatch) {
              current = current[parseInt(arrayMatch[1], 10)];
            } else {
              if (typeof current !== 'object' || !current.hasOwnProperty(key)) {
                return defaultValue;
              }
              current = current[key];
            }
          }
          return current !== undefined ? current : defaultValue;
        } catch (e) {
          console.warn(`SafeGetValue error for path "${path}":`, e);
          return defaultValue;
        }
      }

      function extractCleanValue(rawValue, defaultValue = '--') {
        if (rawValue === null || rawValue === undefined) {
          return defaultValue;
        }
        if (Array.isArray(rawValue)) {
          return rawValue.length > 0 ? String(rawValue[0]) : defaultValue;
        }
        return String(rawValue);
      }

      function setElementText(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
          element.innerText = value;
        }
      }

      function updateProgressBar(barId, valueDisplayId, rawValue, min = 0, max = 100) {
        const bar = document.getElementById(barId);
        const valueDisplay = document.getElementById(valueDisplayId);
        const finalValue = extractCleanValue(rawValue, '0');
        const numericValue = parseFloat(finalValue) || 0;

        if (valueDisplay) {
          valueDisplay.innerText = `${numericValue} / ${max}`;
        }
        if (bar) {
          const range = max - min;
          const percentage = range <= 0 ? 0 : ((numericValue - min) / range) * 100;
          bar.style.width = `${Math.min(100, Math.max(0, percentage))}%`;
        }
      }

      function populateSkillList(listId, skillsData) {
        const listElement = document.getElementById(listId);
        if (!listElement) return;

        const skillsObject = Array.isArray(skillsData) && skillsData.length > 0 ? skillsData[0] : {};
        listElement.innerHTML = '';

        if (skillsObject && typeof skillsObject === 'object' && Object.keys(skillsObject).length > 0) {
          let hasSkills = false;
          for (const skillName in skillsObject) {
            if (Object.hasOwnProperty.call(skillsObject, skillName) && skillName !== '$meta') {
              hasSkills = true;
              const skillDetails = skillsObject[skillName];
              const listItem = document.createElement('li');
              listItem.className = 'skill-list-item';

              const level = extractCleanValue(SafeGetValue(skillDetails, '等级'), 'N/A');
              const desc = extractCleanValue(SafeGetValue(skillDetails, '描述'), '无详细描述');

              listItem.innerHTML = `<div class="skill-name">${skillName}</div><div class="skill-level">Lv: ${level}</div><div class="skill-desc">${desc}</div>`;
              listElement.appendChild(listItem);
            }
          }
          if (!hasSkills) {
            listElement.innerHTML = '<li class="skill-list-item">无技能</li>';
          }
        } else {
          listElement.innerHTML = '<li class="skill-list-item">无技能</li>';
        }
      }

      function setAvatar(elementId, rawValue) {
        const element = document.getElementById(elementId);
        const url = extractCleanValue(rawValue, '');
        if (!element || !url || url === '--') return;

        // user 使用背景图（保持第一个方案）
        if (elementId === 'user-avatar') {
          element.style.backgroundImage = `url('${url}')`;
          return;
        }

        // 角色头像使用 <img> 呈现，提升清晰度并支持高 DPI
        let img = element.querySelector('img.avatar-img');
        if (!img) {
          img = document.createElement('img');
          img.className = 'avatar-img';
          img.alt = elementId;
          img.decoding = 'async';
          img.loading = 'lazy';
          element.innerHTML = '';
          element.appendChild(img);
        }
        img.src = url;
        img.srcset = `${url} 1x, ${url} 2x`;

        // 清理可能残留的背景图样式
        element.style.backgroundImage = '';
      }

      function toggleCharacterCard(charName) {
        const cardToToggleId = `${charName}-card`;
        const selectorToToggleId = `${charName}-avatar-selector`;
        const cardToToggle = document.getElementById(cardToToggleId);
        const selectorToToggle = document.getElementById(selectorToToggleId);

        if (!cardToToggle) return;

        const isCurrentlyExpanded = cardToToggle.classList.contains('expanded');

        document.querySelectorAll('.character-card').forEach(card => card.classList.remove('expanded'));
        document.querySelectorAll('.char-avatar-selector').forEach(sel => sel.classList.remove('active'));

        if (!isCurrentlyExpanded) {
          cardToToggle.classList.add('expanded');
          if (selectorToToggle) selectorToToggle.classList.add('active');
        }
      }

      function renderErrorFallback(message) {
        const statusCard = document.getElementById('status-card');
        if (statusCard) {
          statusCard.innerHTML = `<div class="error-fallback">${message}<br><small>请检查世界书数据或刷新页面重试。</small></div>`;
        }
      }

      async function initDisplay() {
        try {
          if (typeof getChatMessages === 'undefined' || typeof getCurrentMessageId === 'undefined') {
            throw new Error('核心函数 (getChatMessages/getCurrentMessageId) 未定义。');
          }

          const messageId = getCurrentMessageId();
          const messages = await getChatMessages(messageId);

          if (!messages || !Array.isArray(messages) || messages.length === 0) {
            // 现在只检查是否有消息，不要求多条
            throw new Error('无法获取到任何聊天消息。');
          }

          // 直接从最新一条消息（messages[0]）获取 stat_data
          const characterData = SafeGetValue(messages[0], 'data.stat_data');

          if (!characterData || typeof characterData !== 'object' || Object.keys(characterData).length === 0) {
            throw new Error('在最新一条消息中未找到有效的 `stat_data`。');
          }

          const charactersConfig = [
            { id: 'zion', name: '紫音' },
            { id: 'rin', name: '凛' },
            { id: 'kaede', name: '枫' },
          ];
          const knownKeys = ['世界', ...charactersConfig.map(c => c.name)];

          let userKey = Object.keys(characterData).find(key => !knownKeys.includes(key));
          if (!userKey) {
            console.warn('未能动态识别玩家键名，将尝试使用默认占位符。');
            userKey = '{{user}}';
          }

          setElementText('player-name-display', userKey);
          setElementText('user-skills-title', `${userKey} 技能`);
          const user = SafeGetValue(characterData, userKey, {});

          const world = SafeGetValue(characterData, '世界', {});
          const dateStr = extractCleanValue(SafeGetValue(world, '日期'), '--/--/--');
          const periodStr = extractCleanValue(SafeGetValue(world, '时段'), '--');
          const timeStr = extractCleanValue(SafeGetValue(world, '时间'), '--:--');
          setElementText('datetime-value', `${dateStr} // ${periodStr} // ${timeStr}`);
          setElementText('random-event-value', extractCleanValue(SafeGetValue(world, '随机事件'), '无'));
          setElementText('countdown-value', extractCleanValue(SafeGetValue(world, '入侵倒计时'), '--'));

          setAvatar('user-avatar', SafeGetValue(user, '头像'));
          const area = extractCleanValue(SafeGetValue(user, '区域'), '未知');
          const location = extractCleanValue(SafeGetValue(user, '地点'), '未知');
          setElementText('location-info', `${area} - ${location}`);
          updateProgressBar('user-exp-bar', 'user-exp-value', SafeGetValue(user, '经验值'), 0, 100);
          updateProgressBar('user-fallen-bar', 'user-fallen-value', SafeGetValue(user, '淫堕值'), 0, 200);
          setElementText('user-grade-value', extractCleanValue(SafeGetValue(user, '实力等级'), 'N/A'));
          populateSkillList('user-skills-list', SafeGetValue(user, '技能'));

          let firstValidCharId = null;

          for (const charConfig of charactersConfig) {
            const char = SafeGetValue(characterData, charConfig.name);
            if (char) {
              if (!firstValidCharId) firstValidCharId = charConfig.id;

              setAvatar(`${charConfig.id}-avatar-selector`, SafeGetValue(char, '头像'));
              setAvatar(`${charConfig.id}-card-avatar`, SafeGetValue(char, '头像'));
              updateProgressBar(
                `${charConfig.id}-affinity-bar`,
                `${charConfig.id}-affinity-value`,
                SafeGetValue(char, '好感度'),
                0,
                200,
              );
              updateProgressBar(
                `${charConfig.id}-exp-bar`,
                `${charConfig.id}-exp-value`,
                SafeGetValue(char, '经验值'),
                0,
                100,
              );
              updateProgressBar(
                `${charConfig.id}-fallen-bar`,
                `${charConfig.id}-fallen-value`,
                SafeGetValue(char, '淫堕值'),
                0,
                200,
              );
              setElementText(`${charConfig.id}-grade-value`, extractCleanValue(SafeGetValue(char, '实力等级'), 'N/A'));
              setElementText(
                `${charConfig.id}-thoughts-content`,
                extractCleanValue(SafeGetValue(char, '内心想法'), '...'),
              );
              populateSkillList(`${charConfig.id}-skills-list`, SafeGetValue(char, '技能'));
            }
          }

          // 覆盖紫音、凛、枫的头像为指定链接（不影响 user）
          setAvatar('zion-avatar-selector', 'https://files.catbox.moe/5l5zrq.png');
          setAvatar('zion-card-avatar', 'https://files.catbox.moe/5l5zrq.png');
          setAvatar('rin-avatar-selector', 'https://files.catbox.moe/w67gzr.png');
          setAvatar('rin-card-avatar', 'https://files.catbox.moe/w67gzr.png');
          setAvatar('kaede-avatar-selector', 'https://files.catbox.moe/yw1pgp.png');
          setAvatar('kaede-card-avatar', 'https://files.catbox.moe/yw1pgp.png');

          if (firstValidCharId) {
            toggleCharacterCard(firstValidCharId);
          }
        } catch (e) {
          console.error('状态栏初始化失败:', e);
          renderErrorFallback(e.message);
        }
      }

      document.addEventListener('DOMContentLoaded', initDisplay);
    </script>
  </body>
</html>
```

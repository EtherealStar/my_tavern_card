# 变量修正脚本 - 功能说明

## 概述

变量修正脚本用于检测和修正AI不正确修改变量的问题。当AI在返回stat_data时修改了原始值，该脚本能够自动检测并修正这些不正确的修改。

## 问题场景

### 典型问题
- 发送给AI的stat_data中经验值为0
- AI知道经验值为0，但在返回时将其改为50
- 然后对50使用`_.add`函数增加，display_data显示为50->55
- 实际应该是0->5

### 解决方案
- 保存发送给AI时的原始stat_data
- 检查display_data中的"前一个数值"是否与原始值相同
- 如果不同，则将display_data中的值替换为原始值

## 核心功能

### 1. 数据保存
- `saveOriginalStatData()` - 保存发送给AI时的原始stat_data
- `resetOriginalData()` - 重置原始数据

### 2. 数据修正
- `correctDisplayData()` - 检查并修正display_data中的变量
- `isVariableModified(path, currentValue)` - 检查变量是否被AI修改
- `getOriginalValue(path)` - 获取变量的原始值

### 3. 统计信息
- `getCorrectionStats()` - 获取修正统计信息

## 事件监听

### 自动事件监听
脚本会自动监听以下事件：
- `mag_variable_update_started` - 变量更新开始
- `mag_variable_updated` - 变量更新中
- `mag_variable_update_ended` - 变量更新结束
- `message_sending` - 消息发送前
- `message_received` - 消息接收后

### 事件处理逻辑
1. **消息发送前**：保存原始stat_data
2. **消息接收后**：检查并修正display_data
3. **变量更新时**：检测变量是否被AI修改

## 使用方法

### 1. 自动模式
脚本会自动监听事件并执行修正：
```typescript
// 脚本会自动处理以下流程：
// 1. 消息发送前保存原始数据
// 2. 消息接收后检查并修正数据
// 3. 记录修正日志
```

### 2. 手动模式
可以手动调用函数：
```typescript
// 保存原始数据
window.variableCorrection.saveOriginalStatData();

// 修正显示数据
window.variableCorrection.correctDisplayData();

// 获取统计信息
const stats = window.variableCorrection.getCorrectionStats();
```

### 3. 检查变量修改
```typescript
// 检查特定变量是否被修改
const isModified = window.variableCorrection.isVariableModified('user.经验值', 50);

// 获取变量的原始值
const originalValue = window.variableCorrection.getOriginalValue('user.经验值');
```

## 日志记录

脚本会记录详细的修正日志：
```javascript
{
    timestamp: "2024-01-01T12:00:00.000Z",
    path: "user.经验值",
    oldValue: 50,
    newValue: 0,
    userKey: "用户名"
}
```

## 配置选项

### 延迟时间
消息接收后的修正延迟时间（默认100ms）：
```typescript
setTimeout(() => {
    correctDisplayData();
    isMessageSending = false;
}, 100); // 可调整此延迟时间
```

### 事件名称
可根据实际情况调整事件名称：
```typescript
// 当前使用的事件名称
eventOn('message_sending', onMessageSending);
eventOn('message_received', onMessageReceived);
```

## 测试界面

提供了完整的测试界面（index.html），包含：
- 脚本状态检查
- 基本操作按钮
- 测试功能
- 日志输出
- 统计信息显示

## 注意事项

1. **性能考虑**：脚本使用深度复制保存原始数据，对于大型变量表可能影响性能
2. **事件依赖**：脚本依赖特定的事件名称，需要确保事件正确触发
3. **数据完整性**：确保在消息发送前正确保存原始数据
4. **错误处理**：脚本包含完整的错误处理机制

## 扩展功能

### 自定义验证规则
可以扩展`isVariableModified`函数来添加自定义验证规则：
```typescript
function isVariableModified(path: string, currentValue: any): boolean {
    // 添加自定义验证逻辑
    if (path.includes('经验值')) {
        // 特殊处理经验值变量
        return validateExperienceValue(currentValue);
    }
    
    // 默认验证逻辑
    if (!originalStatData || !_.has(originalStatData, path)) {
        return false;
    }
    
    const originalValue = _.get(originalStatData, path);
    return currentValue !== originalValue;
}
```

### 变量白名单
可以添加变量白名单，允许某些变量被AI修改：
```typescript
const WHITELIST_VARIABLES = [
    'user.内心想法',
    'world.随机事件'
];

function isVariableModified(path: string, currentValue: any): boolean {
    // 白名单变量允许修改
    if (WHITELIST_VARIABLES.includes(path)) {
        return false;
    }
    
    // 其他验证逻辑...
}
```

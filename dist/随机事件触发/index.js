function e(){try{if('function'==typeof substitudeMacros){const e=substitudeMacros('<user>');if(e&&'<user>'!==e&&'string'==typeof e)return console.log('[Constants] 使用 substitudeMacros 获取用户键:',e),e}if('function'==typeof window.getVariables){const e=window.getVariables({type:'global'}),o=e?.user_name||e?.username;if(o&&'string'==typeof o)return console.log('[Constants] 从全局变量获取用户键:',o),o}const e=window.SillyTavern;if(e?.name1)return console.log('[Constants] 从SillyTavern获取用户键:',e.name1),e.name1;if('function'==typeof window.getChatMessages)try{const e=window.getChatMessages().find(e=>e.is_user);if(e?.name)return console.log('[Constants] 从聊天消息推断用户键:',e.name),e.name}catch{}return console.warn('[Constants] 无法获取用户键，使用默认值: <user>'),'<user>'}catch(e){return console.error('[Constants] 获取用户键时发生错误:',e),'<user>'}}let o='<user>';try{o=e()}catch{}const a='tavern_helper.random_events.triggered',t=[{name:'姐姐的书架',allowedPeriods:['上午','下午'],allowedLocations:['{{user}}的家']},{name:'不听话的咖啡机',allowedPeriods:['上午'],allowedLocations:['{{user}}的家']},{name:'蔬菜的转移',allowedPeriods:['上午','下午'],allowedLocations:['守护支部']},{name:'天台的午餐',allowedPeriods:['上午'],allowedLocations:['花丘高中']},{name:'冰雕',allowedPeriods:['下午'],allowedLocations:['{{user}}的家']},{name:'晚高峰电车',allowedPeriods:['下午'],allowedLocations:['花丘高中']},{name:'图书馆的守护',allowedPeriods:['上午','下午'],allowedLocations:['花丘高中']},{name:'出浴意外',allowedPeriods:['下午','晚间'],allowedLocations:['{{user}}的家']},{name:'特别辅导',allowedPeriods:['下午','晚间'],allowedLocations:['花丘高中']},{name:'雨天的伞下',allowedPeriods:['下午','晚间'],allowedLocations:['花丘高中']},{name:'失窃的丝袜',allowedPeriods:['下午','晚间'],allowedLocations:['{{user}}的家']},{name:'天台的午睡',allowedPeriods:['上午','下午'],allowedLocations:['花丘高中']},{name:'旧伤疤的故事',allowedPeriods:['下午'],allowedLocations:['花丘高中']},{name:'家庭餐厅的紧急补习',allowedPeriods:['下午','晚间']},{name:'食堂的限定布丁争夺战',allowedPeriods:['上午','下午'],allowedLocations:['守护支部']},{name:'输掉的惩罚',allowedLocations:['{{user}}的家']},{name:'特训',allowedPeriods:['上午','下午'],allowedLocations:['守护支部']},{name:'体育课',allowedPeriods:['下午'],allowedLocations:['花丘高中']},{name:'VR游戏',allowedPeriods:['下午','晚间']},{name:'大姐头的房间',allowedPeriods:['下午','晚间']},{name:'被弄湿的教科书',allowedPeriods:['上午','下午'],allowedLocations:['花丘高中']},{name:'迷路的小猫',allowedPeriods:['下午','晚间']},{name:'商业街的橱窗',allowedPeriods:['下午','晚间']},{name:'关于过去的噩梦',allowedPeriods:['上午','下午'],allowedLocations:['花丘高中']},{name:'训练室的意外',allowedLocations:['守护支部']},{name:'对决',allowedLocations:['守护支部']},{name:'购物之旅',allowedPeriods:['下午','晚间']},{name:'更衣室的意外',allowedPeriods:['下午'],allowedLocations:['花丘高中']},{name:'小巷里的邀请',allowedPeriods:['下午','晚间'],allowedLocations:['花丘高中']},{name:'雨夜的误会',allowedPeriods:['下午','晚间'],allowedLocations:['花丘高中']},{name:'奢侈品店的插曲',allowedPeriods:['下午','晚间']},{name:'商业街的调戏',allowedPeriods:['下午','晚间']},{name:'迷路的女游客'},{name:'后台突袭',allowedPeriods:['下午','晚间']},{name:'风纪注意',allowedPeriods:['上午','下午'],allowedLocations:['花丘高中']},{name:'美术社的缪斯',allowedPeriods:['上午','下午'],allowedLocations:['花丘高中']},{name:'夜间呻吟',allowedPeriods:['晚间'],allowedLocations:['{{user}}的家']},{name:'警官的关心',allowedPeriods:['晚间']}];function n(e){return e.replace(/{{user}}/g,o)}const s='随机事件触发器.状态';eventOn('undefined'!=typeof Mvu?Mvu.events.VARIABLE_UPDATE_ENDED:'mag_variable_update_ended',async function(e,l){try{const l=_.get(e,'initialized_lorebooks',[]);if(!(Array.isArray(l)&&l.includes('伪娘魔法少女')))return;const r=_.get(e,'tavern_helper.affection_events.stage',{});if(r&&'object'==typeof r&&Object.values(r).some(e=>'number'==typeof e&&e>0&&e%2!=0))return;const i=function(e,o,a){try{if('undefined'!=typeof Mvu){const t=Mvu.getMvuVariable(e,o);return void 0===t?a:t}}catch(e){}return _.get(e,`stat_data.${o}`,a)}(e,'世界.随机事件[0]','无'),d=getVariables({type:'script',script_id:getScriptId()}),c=function(e){const o=_.get(e,'随机事件触发器.配置.冷却回复数',1);return'number'==typeof o&&o>=0?o:1}(d),w=_.get(d,`${s}.上次事件名`,'无');let u=_.get(d,`${s}.冷却剩余回复数`,0),m=!1;if('无'!==w&&'无'===i?(u=Math.max(0,c-1),m=!0):u>0&&(u=Math.max(0,u-1),m=!0),_.set(d,`${s}.上次事件名`,i),_.set(d,`${s}.冷却剩余回复数`,u),await replaceVariables(d,{type:'script',script_id:getScriptId()}),'无'!==i)return;if(m)return;const f=function(e){return _.get(e,'stat_data.世界.时段[0]')}(e),g=function(e){return _.get(e,`stat_data.${o}.地点[0]`)}(e);if(!f||!g)return;const P=_.get(e,a,[]),p=t.filter(e=>{if(P.includes(e.name))return!1;const o=!e.allowedPeriods||e.allowedPeriods.includes(f),a=!e.allowedLocations||e.allowedLocations.map(n).includes(g);return o&&a});if(0===p.length)return;const y=.45;if(Math.random()>=y)return;const L=p[Math.floor(Math.random()*p.length)],v=_.get(e,a,[]);await async function(e,o,a,t){try{if('undefined'!=typeof Mvu)return void await Mvu.setMvuVariable(e,o,a,{reason:t})}catch(e){}_.set(e,`stat_data.${o}`,a)}(e,'世界.随机事件[0]',L.name,'随机事件触发'),_.set(e,a,_.uniq([...Array.isArray(v)?v:[],L.name]));const b=getVariables({type:'script',script_id:getScriptId()});_.set(b,`${s}.上次事件名`,L.name),await replaceVariables(b,{type:'script',script_id:getScriptId()})}catch(e){console.error('[随机事件触发器] 出错:',e)}});
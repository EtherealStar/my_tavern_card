var e,a,o,r,t,n={72:(e,a,o)=>{o.a(e,async(e,a)=>{try{var r=o(105);await waitGlobalInitialized('Mvu');const t=[{name:'姐姐的书架',allowedPeriods:['上午','下午'],allowedLocations:['{{user}}的家']},{name:'不听话的咖啡机',allowedPeriods:['上午'],allowedLocations:['{{user}}的家']},{name:'蔬菜的转移',allowedPeriods:['上午','下午'],allowedLocations:['守护支部']},{name:'天台的午餐',allowedPeriods:['上午'],allowedLocations:['花丘高中']},{name:'冰雕',allowedPeriods:['下午'],allowedLocations:['{{user}}的家']},{name:'晚高峰电车',allowedPeriods:['下午'],allowedLocations:['花丘高中']},{name:'图书馆的守护',allowedPeriods:['上午','下午'],allowedLocations:['花丘高中']},{name:'出浴意外',allowedPeriods:['下午','晚间'],allowedLocations:['{{user}}的家']},{name:'特别辅导',allowedPeriods:['下午','晚间'],allowedLocations:['花丘高中']},{name:'雨天的伞下',allowedPeriods:['下午','晚间'],allowedLocations:['花丘高中']},{name:'失窃的丝袜',allowedPeriods:['下午','晚间'],allowedLocations:['{{user}}的家']},{name:'天台的午睡',allowedPeriods:['上午','下午'],allowedLocations:['花丘高中']},{name:'旧伤疤的故事',allowedPeriods:['下午'],allowedLocations:['花丘高中']},{name:'家庭餐厅的紧急补习',allowedPeriods:['下午','晚间']},{name:'食堂的限定布丁争夺战',allowedPeriods:['上午','下午'],allowedLocations:['守护支部']},{name:'输掉的惩罚',allowedLocations:['{{user}}的家']},{name:'特训',allowedPeriods:['上午','下午'],allowedLocations:['守护支部']},{name:'体育课',allowedPeriods:['下午'],allowedLocations:['花丘高中']},{name:'VR游戏',allowedPeriods:['下午','晚间']},{name:'大姐头的房间',allowedPeriods:['下午','晚间']},{name:'被弄湿的教科书',allowedPeriods:['上午','下午'],allowedLocations:['花丘高中']},{name:'迷路的小猫',allowedPeriods:['下午','晚间']},{name:'商业街的橱窗',allowedPeriods:['下午','晚间']},{name:'关于过去的噩梦',allowedPeriods:['上午','下午'],allowedLocations:['花丘高中']},{name:'训练室的意外',allowedLocations:['守护支部']},{name:'对决',allowedLocations:['守护支部']},{name:'购物之旅',allowedPeriods:['下午','晚间']},{name:'更衣室的意外',allowedPeriods:['下午'],allowedLocations:['花丘高中']},{name:'小巷里的邀请',allowedPeriods:['下午','晚间'],allowedLocations:['花丘高中']},{name:'雨夜的误会',allowedPeriods:['下午','晚间'],allowedLocations:['花丘高中']},{name:'奢侈品店的插曲',allowedPeriods:['下午','晚间']},{name:'商业街的调戏',allowedPeriods:['下午','晚间']},{name:'迷路的女游客',allowedPeriods:['上午','下午']},{name:'后台突袭',allowedPeriods:['下午','晚间']},{name:'风纪注意',allowedPeriods:['上午','下午'],allowedLocations:['花丘高中']},{name:'美术社的缪斯',allowedPeriods:['上午','下午'],allowedLocations:['花丘高中']},{name:'夜间呻吟',allowedPeriods:['晚间'],allowedLocations:['{{user}}的家']},{name:'警官的关心',allowedPeriods:['晚间']}];function n(e){return e.replace(/{{user}}/g,r.Xh)}function l(e){return Mvu.getMvuVariable(e,'世界.时段[0]')}function s(e){return Mvu.getMvuVariable(e,`${r.Xh}.地点[0]`)}const i='随机事件触发器.配置',d='随机事件触发器.状态';function c(e){const a=_.get(e,`${i}.冷却回复数`,1);return'number'==typeof a&&a>=0?a:1}async function u(e,a){try{const a=Mvu.getMvuVariable(e,'tavern_helper.affection_events.stage',{default_value:{}});if(a&&'object'==typeof a&&Object.values(a).some(e=>'number'==typeof e&&e>0&&e%2!=0))return;const o=Mvu.getMvuVariable(e,'世界.随机事件[0]',{default_value:'无'}),i=getVariables({type:'script',script_id:getScriptId()}),u=c(i),w=_.get(i,`${d}.上次事件名`,'无');let m=_.get(i,`${d}.冷却剩余回复数`,0),p=!1;if('无'!==w&&'无'===o?(m=Math.max(0,u-1),p=!0):m>0&&(m=Math.max(0,m-1),p=!0),_.set(i,`${d}.上次事件名`,o),_.set(i,`${d}.冷却剩余回复数`,m),await replaceVariables(i,{type:'script',script_id:getScriptId()}),'无'!==o)return;if(p)return;const f=l(e),v=s(e);if(!f||!v)return;const P=r.kM.replace('tavern_helper.',''),b=Mvu.getMvuVariable(e,P,{default_value:[]}),g=t.filter(e=>{if(b.includes(e.name))return!1;const a=!e.allowedPeriods||e.allowedPeriods.includes(f),o=!e.allowedLocations||e.allowedLocations.map(n).includes(v);return a&&o});if(0===g.length)return;const y=.45;if(Math.random()>=y)return;const h=g[Math.floor(Math.random()*g.length)],L=Mvu.getMvuVariable(e,P,{default_value:[]});await Mvu.setMvuVariable(e,'世界.随机事件[0]',h.name,{reason:'随机事件触发'});const M=_.uniq([...Array.isArray(L)?L:[],h.name]);await Mvu.setMvuVariable(e,P,M,{reason:'添加已触发事件'});const V=getVariables({type:'script',script_id:getScriptId()});_.set(V,`${d}.上次事件名`,h.name),await replaceVariables(V,{type:'script',script_id:getScriptId()})}catch(e){console.error('[随机事件触发器] 出错:',e)}}eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,u),a()}catch(w){a(w)}},1)},105:(e,a,o)=>{o.d(a,{Xh:()=>t,kM:()=>n});function r(){try{if('function'==typeof substitudeMacros){const e=substitudeMacros('<user>');if(e&&'<user>'!==e&&'string'==typeof e)return console.log('[Constants] 使用 substitudeMacros 获取用户键:',e),e}if('function'==typeof window.getVariables){const e=window.getVariables({type:'global'}),a=e?.user_name||e?.username;if(a&&'string'==typeof a)return console.log('[Constants] 从全局变量获取用户键:',a),a}const e=window.SillyTavern;if(e?.name1)return console.log('[Constants] 从SillyTavern获取用户键:',e.name1),e.name1;if('function'==typeof window.getChatMessages)try{const e=window.getChatMessages().find(e=>e.is_user);if(e?.name)return console.log('[Constants] 从聊天消息推断用户键:',e.name),e.name}catch{}return console.warn('[Constants] 无法获取用户键，使用默认值: <user>'),'<user>'}catch(e){return console.error('[Constants] 获取用户键时发生错误:',e),'<user>'}}let t='<user>';try{t=r()}catch{}const n='tavern_helper.random_events.triggered'}},l={};function s(e){var a=l[e];if(void 0!==a)return a.exports;var o=l[e]={exports:{}};return n[e](o,o.exports,s),o.exports}e='function'==typeof Symbol,a=e?Symbol('webpack queues'):'__webpack_queues__',o=e?Symbol('webpack exports'):'__webpack_exports__',r=e?Symbol('webpack error'):'__webpack_error__',t=e=>{e&&e.d<1&&(e.d=1,e.forEach(e=>e.r--),e.forEach(e=>e.r--?e.r++:e()))},s.a=(e,n,l)=>{var s;l&&((s=[]).d=-1);var i,d,c,u=new Set,w=e.exports,m=new Promise((e,a)=>{c=a,d=e});m[o]=w,m[a]=e=>(s&&e(s),u.forEach(e),m.catch(e=>{})),e.exports=m,n(e=>{var n;i=(e=>e.map(e=>{if(null!==e&&'object'==typeof e){if(e[a])return e;if(e.then){var n=[];n.d=0,e.then(e=>{l[o]=e,t(n)},e=>{l[r]=e,t(n)});var l={};return l[a]=e=>e(n),l}}var s={};return s[a]=e=>{},s[o]=e,s}))(e);var l=()=>i.map(e=>{if(e[r])throw e[r];return e[o]}),d=new Promise(e=>{(n=()=>e(l)).r=0;var o=e=>e!==s&&!u.has(e)&&(u.add(e),e&&!e.d&&(n.r++,e.push(n)));i.map(e=>e[a](o))});return n.r?d:l()},e=>(e?c(m[r]=e):d(w),t(s))),s&&s.d<0&&(s.d=0)},s.d=(e,a)=>{for(var o in a)s.o(a,o)&&!s.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:a[o]})},s.o=(e,a)=>Object.prototype.hasOwnProperty.call(e,a);var i=s(72);i=await i;
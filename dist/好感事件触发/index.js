function t(){try{if('function'==typeof substitudeMacros){const t=substitudeMacros('<user>');if(t&&'<user>'!==t&&'string'==typeof t)return console.log('[Constants] 使用 substitudeMacros 获取用户键:',t),t}if('function'==typeof window.getVariables){const t=window.getVariables({type:'global'}),e=t?.user_name||t?.username;if(e&&'string'==typeof e)return console.log('[Constants] 从全局变量获取用户键:',e),e}const t=window.SillyTavern;if(t?.name1)return console.log('[Constants] 从SillyTavern获取用户键:',t.name1),t.name1;if('function'==typeof window.getChatMessages)try{const t=window.getChatMessages().find(t=>t.is_user);if(t?.name)return console.log('[Constants] 从聊天消息推断用户键:',t.name),t.name}catch{}return console.warn('[Constants] 无法获取用户键，使用默认值: <user>'),'<user>'}catch(t){return console.error('[Constants] 获取用户键时发生错误:',t),'<user>'}}let e='<user>';try{e=t()}catch{}const n='tavern_helper.random_events.triggered',s=['紫音','凛','枫'],o=[50,100,150],a='好感事件触发器.配置',r=t=>`tavern_helper.affection_events.stage.${t}`,i=t=>`tavern_helper.lust_events.stage.${t}`,c='圣女传承';function u(t,e,n){try{if('undefined'!=typeof Mvu){const s=Mvu.getMvuVariable(t,e);return void 0===s?n:s}}catch(t){}return _.get(t,`stat_data.${e}`,n)}async function f(t,e,n,s){try{if('undefined'!=typeof Mvu)return void await Mvu.setMvuVariable(t,e,n,{reason:s})}catch(t){}_.set(t,`stat_data.${e}`,n)}const l={紫音:{1:'女仆修行',2:'心理评估',3:'便利店圣女'},凛:{1:'任务意外',2:'家庭性教育',3:'后宫失火'},枫:{1:'时光胶囊',2:'花火大会',3:'素材争夺战'}};function d(t,e){const n=l[t];return n&&n[e]?n[e]:`好感事件-${t}-阶段${e}`}const g={1:'浴室惩罚',2:'性处理委员',3:'极乐婚典'};const v={1:'失控净化',2:'青梅目前犯',3:'异次元大团圆'};function y(t){return t>=o[2]?3:t>=o[1]?2:t>=o[0]?1:0}eventOn('undefined'!=typeof Mvu?Mvu.events.VARIABLE_UPDATE_ENDED:'mag_variable_update_ended',async function(t){try{const l=function(t){const e=_.get(t,`${a}.启用全局`,!0),n={};for(const e of s)n[e]=_.get(t,`${a}.启用角色.${e}`,!0);return{globalEnabled:e,roleEnabled:n,saintEnabled:_.get(t,`${a}.启用圣女传承`,!0),saintThreshold:_.get(t,`${a}.圣女传承阈值`,70)}}(getVariables({type:'script',script_id:getScriptId()}));if(!l.globalEnabled)return;for(const e of s){const n=u(t,`${e}.好感度[0]`,0),s=_.get(t,r(e),0),o=y(n);if(o>Math.ceil(s/2)){const n=2*o-1;_.set(t,r(e),n)}if('凛'===e){const e=y(u(t,'凛.淫堕值[0]',0)),n=_.get(t,i('凛'),0);if(e>Math.ceil(n/2)){const n=2*e-1;_.set(t,i('凛'),n)}}if('紫音'===e){const e=y(u(t,'紫音.淫堕值[0]',0)),n=_.get(t,i('紫音'),0);if(e>Math.ceil(n/2)){const n=2*e-1;_.set(t,i('紫音'),n)}}}if('无'===u(t,'世界.随机事件[0]','无')){const a=u(t,`${e}.淫堕值[0]`,0),y=u(t,`${e}.实力等级[0]`,''),b=_.get(t,n,[]);if(l.saintEnabled&&a>=l.saintThreshold&&'S'===y&&!b.includes(c)){await f(t,'世界.随机事件[0]',c,'圣女传承');const e=_.get(t,n,[]);_.set(t,n,_.uniq([...Array.isArray(e)?e:[],c]))}else{if(l.roleEnabled['凛']){const e=_.get(t,i('凛'),0);if(e>0&&e%2!=0){const n=g[o=(e+1)/2]??`凛淫堕事件-阶段${o}`;return await f(t,'世界.随机事件[0]',n,'凛淫堕值触发'),void _.set(t,i('凛'),e+1)}}if(l.roleEnabled['紫音']){const e=_.get(t,i('紫音'),0);if(e>0&&e%2!=0){const n=(e+1)/2,s=function(t){return v[t]??`紫音淫堕事件-阶段${t}`}(n);return await f(t,'世界.随机事件[0]',s,'紫音淫堕值触发'),2===n&&await f(t,'紫音.心魔[0]',0,'紫音淫堕阶段2触发'),void _.set(t,i('紫音'),e+1)}}t:for(const e of s){if(!l.roleEnabled[e])continue;const n=_.get(t,r(e),0);if(n>0&&n%2!=0){const s=(n+1)/2,o=d(e,s);if(await f(t,'世界.随机事件[0]',o,'好感事件触发'),'紫音'===e&&3===s){2===u(t,'紫音.心魔[0]',2)&&await f(t,'紫音.心魔[0]',1,'便利店圣女触发')}_.set(t,r(e),n+1);break t}}}}}catch(t){console.error('[好感事件触发器] 运行出错:',t)}var o});
<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>变量修正脚本测试</title><style>body{font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:20px;background-color:#f5f5f5}.container{background-color:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1)}.section{margin-bottom:20px;padding:15px;border:1px solid #ddd;border-radius:5px}.section h3{margin-top:0;color:#333}button{background-color:#007bff;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;margin:5px}button:hover{background-color:#0056b3}.log{background-color:#f8f9fa;border:1px solid #dee2e6;border-radius:4px;padding:10px;max-height:300px;overflow-y:auto;font-family:monospace;font-size:12px}.status{padding:10px;border-radius:4px;margin:10px 0}.status.success{background-color:#d4edda;color:#155724;border:1px solid #c3e6cb}.status.error{background-color:#f8d7da;color:#721c24;border:1px solid #f5c6cb}.status.info{background-color:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}</style><script type="module">let t={},e=!1;const a=substitudeMacros('<user>');function n(){try{const e=getVariables({type:'chat'});e&&e.stat_data&&(t=_.cloneDeep(e.stat_data),console.log('已保存原始stat_data:',t))}catch(t){console.error('保存原始stat_data时出错:',t)}}function o(){try{const e=getVariables({type:'chat'});if(!e||!e.display_data||!t)return;const a=e.display_data;let n=0;for(const[e,o]of Object.entries(a))if(Array.isArray(o)&&o.length>0&&_.has(t,e)){const a=_.get(t,e);if(o[0]!==a){const t=o[0];o[0]=a,n++,console.warn(`修正变量 ${e}: ${t} -> ${a}`),s(e,t,a)}}n>0&&console.log(`共修正了 ${n} 个变量`)}catch(t){console.error('修正display_data时出错:',t)}}function s(t,e,n){const o={timestamp:(new Date).toISOString(),path:t,oldValue:e,newValue:n,userKey:a};console.log('变量修正日志:',o)}function r(e,a){if(!t||!_.has(t,e))return!1;return a!==_.get(t,e)}function i(e){return t&&_.has(t,e)?_.get(t,e):null}eventOn('mag_variable_update_started',function(t,a){e||console.log('变量更新开始')}),eventOn('mag_variable_updated',function(t,a,n,o){if(!e&&r(a,o)){const t=i(a);console.warn(`检测到变量被修改: ${a}`,{original:t,old:n,new:o})}}),eventOn('mag_variable_update_ended',function(t,a){e||console.log('变量更新结束')}),eventOn('message_sending',function(){e=!0,n(),console.log('消息发送前：已保存原始stat_data')}),eventOn('message_received',function(){e&&setTimeout(()=>{o(),e=!1,console.log('消息接收后：已检查并修正display_data')},100)}),window.variableCorrection={saveOriginalStatData:n,correctDisplayData:o,isVariableModified:r,getOriginalValue:i,resetOriginalData:function(){t={},console.log('已重置原始数据')},getCorrectionStats:function(){const e=getVariables({type:'chat'});if(!e||!e.display_data||!t)return{total:0,corrected:0,details:[]};const a=e.display_data,n=[];let o=0;for(const[e,s]of Object.entries(a))if(Array.isArray(s)&&s.length>0&&_.has(t,e)){const a=_.get(t,e),r=s[0],i=r!==a;n.push({path:e,original:a,current:r,corrected:i}),i&&o++}return{total:n.length,corrected:o,details:n}}},console.log('变量修正脚本已加载');</script></head><body><div class="container"><h1>变量修正脚本测试界面</h1><div class="section"><h3>脚本状态</h3><div id="scriptStatus" class="status info">脚本加载中...</div></div><div class="section"><h3>基本操作</h3><button onclick="saveOriginalData()">保存原始数据</button> <button onclick="correctDisplayData()">修正显示数据</button> <button onclick="resetData()">重置数据</button> <button onclick="getStats()">获取统计信息</button></div><div class="section"><h3>测试功能</h3><button onclick="testVariableModification()">测试变量修改检测</button> <button onclick="simulateMessageSending()">模拟消息发送</button> <button onclick="simulateMessageReceived()">模拟消息接收</button></div><div class="section"><h3>日志输出</h3><div id="logOutput" class="log"></div><button onclick="clearLog()">清空日志</button></div><div class="section"><h3>统计信息</h3><div id="statsOutput" class="log"></div></div></div><script>const originalLog=console.log,originalWarn=console.warn,originalError=console.error;function addToLog(o,e="log"){const t=document.getElementById("logOutput"),n=(new Date).toLocaleTimeString(),r=document.createElement("div");r.style.color="error"===e?"red":"warn"===e?"orange":"black",r.textContent=`[${n}] ${o}`,t.appendChild(r),t.scrollTop=t.scrollHeight}function saveOriginalData(){window.variableCorrection?window.variableCorrection.saveOriginalStatData():addToLog("脚本未加载","error")}function correctDisplayData(){window.variableCorrection?window.variableCorrection.correctDisplayData():addToLog("脚本未加载","error")}function resetData(){window.variableCorrection?window.variableCorrection.resetOriginalData():addToLog("脚本未加载","error")}function getStats(){if(window.variableCorrection){const o=window.variableCorrection.getCorrectionStats();document.getElementById("statsOutput").innerHTML="<pre>"+JSON.stringify(o,null,2)+"</pre>"}else addToLog("脚本未加载","error")}function testVariableModification(){if(window.variableCorrection){addToLog(`测试变量修改检测: test.path = 50, 是否被修改: ${window.variableCorrection.isVariableModified("test.path",50)}`)}else addToLog("脚本未加载","error")}function simulateMessageSending(){window.variableCorrection?"function"==typeof eventEmit?eventEmit("message_sending"):addToLog("模拟消息发送事件"):addToLog("脚本未加载","error")}function simulateMessageReceived(){window.variableCorrection?"function"==typeof eventEmit?eventEmit("message_received"):addToLog("模拟消息接收事件"):addToLog("脚本未加载","error")}function clearLog(){document.getElementById("logOutput").innerHTML=""}console.log=function(...o){originalLog.apply(console,o),addToLog(o.join(" "),"log")},console.warn=function(...o){originalWarn.apply(console,o),addToLog(o.join(" "),"warn")},console.error=function(...o){originalError.apply(console,o),addToLog(o.join(" "),"error")},window.addEventListener("load",function(){setTimeout(()=>{window.variableCorrection?(document.getElementById("scriptStatus").innerHTML="<strong>脚本已加载</strong><br>变量修正功能可用",document.getElementById("scriptStatus").className="status success"):(document.getElementById("scriptStatus").innerHTML="<strong>脚本未加载</strong><br>请检查脚本是否正确加载",document.getElementById("scriptStatus").className="status error")},1e3)})</script></body></html>